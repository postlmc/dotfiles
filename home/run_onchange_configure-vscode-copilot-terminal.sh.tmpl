#!/bin/bash
# Configure VS Code to use bash with ACTIVE_AGENT for Copilot terminal
# hash: {{ include "dot_local/bin/executable_copilot-podman-terminal.sh" | sha256sum }}

# Detect OS and set appropriate paths
if [[ "$OSTYPE" == "darwin"* ]]; then
    SETTINGS_FILE="$HOME/Library/Application Support/Code/User/settings.json"
    PROFILE_KEY="chat.tools.terminal.terminalProfile.osx"
else
    SETTINGS_FILE="$HOME/.config/Code/User/settings.json"
    PROFILE_KEY="chat.tools.terminal.terminalProfile.linux"
fi

SETTINGS_DIR="$(dirname "$SETTINGS_FILE")"

# Create directory if it doesn't exist
mkdir -p "$SETTINGS_DIR"

# Create empty JSON if file doesn't exist
if [ ! -f "$SETTINGS_FILE" ]; then
    echo '{}' > "$SETTINGS_FILE"
fi

# Check if setting already exists
if grep -q "\"$PROFILE_KEY\"" "$SETTINGS_FILE"; then
    # Replace existing setting using sed (preserves comments)
    # This is a multi-line replacement that handles the nested structure
    
    # Option 1: Use bash directly with ACTIVE_AGENT environment variable
    # Find and replace the entire profile block
    sed -i.bak -E "/\"$PROFILE_KEY\":/,/\}/c\\
    \"$PROFILE_KEY\": {\\
        \"path\": \"bash\",\\
        \"env\": {\\
            \"ACTIVE_AGENT\": \"Copilot\"\\
        }\\
    }," "$SETTINGS_FILE"
    
    # Option 2: Use Podman container (commented out - uncomment to switch)
    # sed -i.bak -E "/\"$PROFILE_KEY\":/,/\}/c\\
    # \"$PROFILE_KEY\": {\\
    #     \"path\": \"$HOME/.local/bin/copilot-podman-terminal.sh\"\\
    # }," "$SETTINGS_FILE"
    
    rm -f "$SETTINGS_FILE.bak"
else
    # Add new setting before the final closing brace (preserves comments)
    sed -i.bak -E '$s/}/    "'"$PROFILE_KEY"'": {\
        "path": "bash",\
        "env": {\
            "ACTIVE_AGENT": "Copilot"\
        }\
    }\
}/' "$SETTINGS_FILE"
    rm -f "$SETTINGS_FILE.bak"
fi

echo "âœ“ Updated VS Code settings for Copilot terminal ($PROFILE_KEY)"
echo "  - Shell: bash"
echo "  - Environment: ACTIVE_AGENT=Copilot"
